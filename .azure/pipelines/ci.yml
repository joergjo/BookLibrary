trigger:
  paths:
    include:
    - src
    - test

pr:
  branches:
    include:
    - master
  paths:
    include:
    - src
    - test

# To adopt this build pipeline to your environment, update the following
# variables:
# - azureServiceConnection: A reference to your AzureRM service connection
# - dockerRegistryServiceConnection: A reference to your registry
# - environment: The name of the environment to deploy to (will be created automatically if it doesn't exist)
# - imageRepository: The repository to push the image to
# - webAppName: The name of your web app
variables:
  azureServiceConnection: 'azure/vs'
  buildConfiguration: 'Release'
  buildContext: '.'
  dockerfilePath: 'src/BookLibrary/Dockerfile'
  dockerRegistryServiceConnection: 'dockerhub/joergjo'
  dotnetVersion: '3.1.x'
  environment: 'default'
  imageRepository: 'joergjo/booklibrary-netcore'
  tag: 'ci-$(Build.BuildId)'
  webAppName: 'joergjo-booklibrary'
  vmImageName: 'ubuntu-latest'

stages:
  - stage: Build
    jobs:
    - job: Dotnet_Build
      displayName: 'Run dotnet build and test'
      pool:
        vmImageName: $(vmImageName)
      steps:
      - task: UseDotNet@2
        displayName: 'Install .NET Core SDK $(dotnetVersion)'
        inputs:
          packageType: sdk
          version: $(dotnetVersion)
          installationPath: '$(Agent.ToolsDirectory)/dotnet'

      - task: DotNetCoreCLI@2
        displayName: Build
        inputs:
          projects: |
            **/BookLibrary.Test.csproj
          arguments: '--configuration $(buildConfiguration)'

      - task: DotNetCoreCLI@2
        displayName: Test
        inputs:
          command: test
          projects: |
            **/BookLibrary.Test.csproj
          arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage"'

      - task: PublishCodeCoverageResults@1
        displayName: 'Publish code coverage report'
        inputs:
          codeCoverageTool: 'cobertura'
          summaryFileLocation: '$(Agent.TempDirectory)/*/coverage.cobertura.xml'

    - job: Docker_Build
      displayName: 'Run docker build'
      condition: |
        and
        (
          in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual'),
          eq(variables['Build.SourceBranchName'], 'master')
        )
      pool:
        vmImageName: $(vmImageName)
      steps:
        - task: Docker@2
          displayName: 'Build and push image to container registry'
          inputs:
            command: buildAndPush
            repository: $(imageRepository)
            dockerfile: $(dockerfilePath)
            buildContext: $(buildContext)
            containerRegistry: $(dockerRegistryServiceConnection)
            tags: |
              $(tag)
              latest

  - stage: Deploy
    dependsOn: Build
    jobs:
      - deployment: Deploy_WebApp
        displayName: 'Deploy container image on Azure App Service'
        condition: |
          and
          (
            in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual'),
            eq(variables['Build.SourceBranchName'], 'master')
          )
        pool:
          vmImageName: $(vmImageName)
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebAppContainer@1
                  displayName: 'Azure Web App on Container Deploy: $(webAppName))'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    appName: $(webAppName)
                    imageName: $(imageRepository)
